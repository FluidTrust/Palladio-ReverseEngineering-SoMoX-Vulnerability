package org.palladiosimulator.pcm.confidentiality.reverseengineering.staticcodeanalysis.test;

import static org.junit.jupiter.api.Assertions.assertEquals;

import java.nio.file.Path;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.palladiosimulator.pcm.confidentiality.reverseengineering.staticcodeanalysis.SnykCLIStaticCodeAnalyst;
import org.palladiosimulator.pcm.confidentiality.reverseengineering.staticcodeanalysis.StaticCodeAnalyisResult;

public class SnykParsingTest {

    private String fakeoutput = "Testing /home/lukas/git/sms/...\n" + "\n"
            + "Tested 44 dependencies for known issues, found 18 issues, 18 vulnerable paths.\n" + "\n" + "\n"
            + "Issues with no direct upgrade or patch:\n"
            + "  ✗ XML External Entity (XXE) Injection [High Severity][https://snyk.io/vuln/SNYK-JAVA-COMFASTERXMLJACKSONCORE-1048302] in com.fasterxml.jackson.core:jackson-databind@2.10.0\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-actuator@2.2.0.RELEASE > org.springframework.boot:spring-boot-actuator-autoconfigure@2.2.0.RELEASE > com.fasterxml.jackson.core:jackson-databind@2.10.0\n"
            + "  This issue was fixed in versions: 2.6.7.4, 2.9.10.7, 2.10.5.1\n"
            + "  ✗ Information Exposure [Low Severity][https://snyk.io/vuln/SNYK-JAVA-ORGAPACHECOMMONS-559327] in org.apache.commons:commons-dbcp2@2.7.0\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.apache.commons:commons-dbcp2@2.7.0\n"
            + "  No upgrade or patch available\n"
            + "  ✗ HTTP Request Smuggling [Medium Severity][https://snyk.io/vuln/SNYK-JAVA-ORGAPACHETOMCATEMBED-1017119] in org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-tomcat@2.2.0.RELEASE > org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "  This issue was fixed in versions: 10.0.0-M8, 9.0.38, 8.5.5\n"
            + "  ✗ Information Exposure [Medium Severity][https://snyk.io/vuln/SNYK-JAVA-ORGAPACHETOMCATEMBED-1048292] in org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-tomcat@2.2.0.RELEASE > org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "  This issue was fixed in versions: 8.5.60, 9.0.40, 10.0.0-M10\n"
            + "  ✗ Information Disclosure [Medium Severity][https://snyk.io/vuln/SNYK-JAVA-ORGAPACHETOMCATEMBED-1061939] in org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-tomcat@2.2.0.RELEASE > org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "  This issue was fixed in versions: 10.0.0-M10, 9.0.40, 8.5.60, 7.0.107\n"
            + "  ✗ Remote Code Execution (RCE) [High Severity][https://snyk.io/vuln/SNYK-JAVA-ORGAPACHETOMCATEMBED-1080637] in org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-tomcat@2.2.0.RELEASE > org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "  This issue was fixed in versions: 10.0.2, 9.0.43, 8.5.63, 7.0.108\n"
            + "  ✗ HTTP Request Smuggling [Medium Severity][https://snyk.io/vuln/SNYK-JAVA-ORGAPACHETOMCATEMBED-1080638] in org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-tomcat@2.2.0.RELEASE > org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "  This issue was fixed in versions: 10.0.2, 9.0.43, 8.5.63\n"
            + "  ✗ Session Fixation [Low Severity][https://snyk.io/vuln/SNYK-JAVA-ORGAPACHETOMCATEMBED-538488] in org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-tomcat@2.2.0.RELEASE > org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "  This issue was fixed in versions: 9.0.30, 8.5.50, 7.0.99\n"
            + "  ✗ Privilege Escalation [High Severity][https://snyk.io/vuln/SNYK-JAVA-ORGAPACHETOMCATEMBED-538490] in org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-tomcat@2.2.0.RELEASE > org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "  This issue was fixed in versions: 9.0.29\n"
            + "  ✗ Remote Code Execution (RCE) [High Severity][https://snyk.io/vuln/SNYK-JAVA-ORGAPACHETOMCATEMBED-570072] in org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-tomcat@2.2.0.RELEASE > org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "  This issue was fixed in versions: 10.0.0-M5, 9.0.35, 8.5.55, 7.0.104\n"
            + "  ✗ Denial of Service (DoS) [Medium Severity][https://snyk.io/vuln/SNYK-JAVA-ORGAPACHETOMCATEMBED-584427] in org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-tomcat@2.2.0.RELEASE > org.apache.tomcat.embed:tomcat-embed-core@9.0.27\n"
            + "  This issue was fixed in versions: 10.0.0-M7, 9.0.37, 8.5.57\n"
            + "  ✗ Cross-site Scripting (XSS) [Medium Severity][https://snyk.io/vuln/SNYK-JAVA-ORGHIBERNATEVALIDATOR-541187] in org.hibernate.validator:hibernate-validator@6.0.17.Final\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-validation@2.2.0.RELEASE > org.hibernate.validator:hibernate-validator@6.0.17.Final\n"
            + "  This issue was fixed in versions: 6.0.18.Final, 6.1.0.Final\n"
            + "  ✗ Improper Input Validation [Medium Severity][https://snyk.io/vuln/SNYK-JAVA-ORGHIBERNATEVALIDATOR-568163] in org.hibernate.validator:hibernate-validator@6.0.17.Final\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-validation@2.2.0.RELEASE > org.hibernate.validator:hibernate-validator@6.0.17.Final\n"
            + "  This issue was fixed in versions: 6.0.19.Final, 6.1.3.Final\n"
            + "  ✗ Improper Input Validation [High Severity][https://snyk.io/vuln/SNYK-JAVA-ORGSPRINGFRAMEWORK-1009832] in org.springframework:spring-web@5.2.0.RELEASE\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework:spring-web@5.2.0.RELEASE\n"
            + "  This issue was fixed in versions: 4.3.29.RELEASE, 5.0.19.RELEASE, 5.1.18.RELEASE, 5.2.9.RELEASE\n"
            + "  ✗ Privilege Escalation [Medium Severity][https://snyk.io/vuln/SNYK-JAVA-ORGSPRINGFRAMEWORK-1296829] in org.springframework:spring-web@5.2.0.RELEASE\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework:spring-web@5.2.0.RELEASE\n"
            + "  This issue was fixed in versions: 5.3.7, 5.2.15.RELEASE\n"
            + "  ✗ Reflected File Download (RFD) [High Severity][https://snyk.io/vuln/SNYK-JAVA-ORGSPRINGFRAMEWORK-559346] in org.springframework:spring-web@5.2.0.RELEASE\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework:spring-web@5.2.0.RELEASE\n"
            + "  This issue was fixed in versions: 5.2.3, 5.1.13, 5.0.16\n"
            + "  ✗ Cross-Site Request Forgery (CSRF) [Medium Severity][https://snyk.io/vuln/SNYK-JAVA-ORGSPRINGFRAMEWORK-542933] in org.springframework:spring-webmvc@5.2.0.RELEASE\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-web@2.2.0.RELEASE > org.springframework:spring-webmvc@5.2.0.RELEASE\n"
            + "  This issue was fixed in versions: 5.2.3\n"
            + "  ✗ Denial of Service (DoS) [Medium Severity][https://snyk.io/vuln/SNYK-JAVA-ORGYAML-537645] in org.yaml:snakeyaml@1.25\n"
            + "    introduced by org.springframework.boot:smsApplication@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter-actuator@2.2.0.RELEASE > org.springframework.boot:spring-boot-starter@2.2.0.RELEASE > org.yaml:snakeyaml@1.25\n"
            + "  This issue was fixed in versions: 1.26";

    public SnykCLIStaticCodeAnalyst analyst;

    @BeforeEach
    public void setUp() {
        analyst = new SnykCLIStaticCodeAnalyst(Path.of("res/bin/"), Path.of("res/out/"), null, null);
    }

    /**
     * Test empty String as input. Since its an valid input but nothing to parse an empty collection
     * of issues is expected.
     */
    @Test
    public void emptyStringTest() {
        StaticCodeAnalyisResult result = analyst.parseSnykCLIOutput("");
        assertEquals(result.getIssues()
            .size(), 0);
    }

    /**
     * Test null as input. Since its no valid input null as return value is expected.
     */
    @Test
    public void nullStringTest() {
        StaticCodeAnalyisResult result = analyst.parseSnykCLIOutput(null);
        assertEquals(result.getIssues()
            .size(), 0);
    }

    /**
     * Test valid String as input. Since its an valid input and 18 lines of issues to parse, 18
     * issues are expected as result.
     */
    @Test
    public void rightNumberOfParsedIssuesTest() {
        StaticCodeAnalyisResult result = analyst.parseSnykCLIOutput(fakeoutput);
        assertEquals(result.getIssues()
            .size(), 18);
    }

    /**
     * Test invalid String as input. Since its an valid input but nothing to parse an empty
     * collection of issues is expected.
     */
    @Test
    public void invalidStringInputTest() {
        StaticCodeAnalyisResult result = analyst.parseSnykCLIOutput("abcde[asd]asd");
        assertEquals(result.getIssues()
            .size(), 0);
    }

    /**
     * Test valid String with new line placeholders as input. Since its an valid input but nothing
     * to parse an empty collection of issues is expected.
     */
    @Test
    public void emptyLinesTest() {
        StaticCodeAnalyisResult result = analyst.parseSnykCLIOutput("✗✗");
        assertEquals(result.getIssues()
            .size(), 0);
    }
}
